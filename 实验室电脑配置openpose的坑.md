# 实验室配置Openpose小结

2020/1/16

使用实验室的电脑配置openpose的时候，遇到了很多的问题，首先回顾一下我是怎么做的，接着小结一下自己的经历。

## 回顾经历  

#### 第一阶段
 一开始，我在Ubuntu16上安装openpose，遇到的问题是protoc版本的问题，例如 _error This file was generated by an older version of protoc which is_，Ubuntu16的protoc版本是2.6， 而人家需求的版本是3.11 以上吧，因为 _google/protobuf/port_def.inc: No such file or directory_, 所以我当时严重怀疑是Ubuntu自己的版本的问题，但是我还是耐着性子更新了protoc的版本到3.11.2，以及使用anaconda也安装了最新版本的anaconda，然后一步一步的趟坑，先把caffe编译成功，然后把openpose编译成功，以为终于大功告成，结果出现的居然是说protoc版本需要的是3.10以上，但是我的版本是3.5。 问题是我从来没有装过protoc 3.5, 采用*whereis protoc*，也没有protoc的版本呀，后来就在anaconda环境下叕装了一遍caffe, 确保我的caffe是在protoc 3.11的版本下安装的，也重新编译了openpose，结果证明问题是一模一样的，也是**core dump, segment default**,这个时候的我有些纳闷儿了，感觉是Ubuntu16自己本身的问题，所以我决定重装系统，在Ubuntu18下做。说干就干，周一开始了重装系统的旅途。

#### 第二阶段
电脑是外星人服务器，显卡是1080ti，在安装cuda的过程中也是遇到很多很大的问题，比如使用命令行*sudo systemctl isolate graphical.target*, 进入字符界面以后回不到图形界面了，网上有的说法其实并不可行，但是Ubuntu18中的确不能用*sudo service lightdm stop*进入字符界面进行cuda的安装，后来对于安装显卡驱动和cuda的方法是：
* 删除已有的nvidia驱动
* 禁止nouvean 千万不要在blacklist.conf中添加，一般来说是新建一个blacklist,否则电脑就不能进入图形界面了
* sudo gedit /etc/modprobe.d/blacklist-nouveau.conf
* 写入
      
        blacklist nouveau  
        option nouveau modeset=0 
* sudo add-apt-repository ppa:graphics-drivers/ppa (务必更新)
* sudo apt update
* ubuntu-drivers devices（可以找到被推荐的显卡驱动）
* sudo ubuntu-drivers autoinstall
* 安装cuda官网要求来安装就可以， 选择deb(local)进行安装，就没啥问题
* 后面测试cuda是否安装成功的方法是：

        cd /usr/local/cuda-10.2/samples/1_Utilities/deviceQuery/
        sudo make
        ./deviceQuery

最后在不断的重启以及重装电脑的试错的过程中，终于装好了cuda， cudnn， 显卡驱动。

#### 第三阶段

安装好Ubuntu18以后，还是很愉快的，因为ubuntu18貌似可以多次重启而不掉显卡（当然也可能是没有长期运行显卡，可能后续才知道），但是总体而言流畅了很多很多。

接下来就是安装caffe，中间也遇到了很多的问题，尝试着一个一个的解决掉，在anaconda环境下安装了**protobuf 3.10**,而不是3.11，这个操作是有效的，因为解决了*fatal error: google/protobuf/port_def.inc: No such file or directory*这一问题，但是事实是后面这个问题依然存在。我参考了自己电脑的配置，其实我的电脑中在编译openpose的时候选择的opencv的路径是*/usr/share/OpenCV*, 而不是**anaconda3/envs/op/share/OpenCV/**之下，后面又遇到较多的编译问题，尝试一个一个的解决以后，使用命令行测试的时候，结果仍然是core dumpt， 很奇怪。

接着我创建一个叫做test的anaconda的环境，在这个环境中**不**安装 **opencv protoc cmake**, 下载**cmake3.15.6**源码进行升级。也**不**编译caffe, 只是用修改过了的caffe放在3rdparty里面，然后编译，编译果然通过了，但是仍然是**core dump**, 我直接copy了我的电脑里安装的openpose文件夹，

* cd openpose_test && rm -r build && cd build && cmake .. && make -j7

结果证明不仅编译成功，而且demo也可以运行了。

更新 2020/01/17

后续需要调用Python的API接口，我的步骤是（神奇的好了，但是我自己也不清楚到底是什么原因）：

1. 在cmake-gui 中加入 pybind 一类的操作

2. go look for the file - build/python/openpose/pyopenpose.cpython-36m-x86_64-linux-gnu.so and copy to /usr/local/lib/python3.6/dist-packages

3. in /usr/local/lib/python3.6/dist-packages

   sudo ln -s pyopenpose.cpython-36m-x86_64-linux-gnu.so pyopenpose
4.  run make install in /openpose/build/python/openpose

5. go into /openpose/build/python/

        python
        from openpose import pyopenpose
6. 如果不行，就重新copy 一下文件，在 /usr/share/OpenCV 的选择下, 选择 Python Build 重新编译openpose，按照上述操作再试一遍。 

## 小结

1. 编译成功的原因有一下几个要素：

    * ubuntu18 系统，通过sudo apt install 可以安装 opencv 3.2, protoc 3.0 g++ 7.4 gcc 7.4
    * 使用源码安装了cmake 3.15.6
    * 使用之前编译成功的代码
    * 在 anaconda中创建了一个空的环境，该环境中没有安装 opencv 3.4, protoc 3.11， cmake
    * 直接编译，将caffe以及openpose放在一起编译

2. openpose需要的环境是 cmake 3.15 或者比较新才行，不然就会出现问题；

        protoc 3.0 --> caffe --> openpose
        cuda 10.2 --> opencv --> openpose
        cmake -----------------> openpsoe
3. 在编译成功以后再通过anaconda安装opencv，不要让 anaconda的opencv影响到openpose的编译过程。

4. 为什么我自己的代码里面的openpose编译成功后没有coredumpt, 有点儿迷，后续还得搞清楚才是。

5. sudo protoc --version 和 protoc --version 结果不一样，*sudo protoc --version*的结果是系统本身的(3.0)， *protoc --version*是自己anaconda 环境下的结果。所以sudo make 和 make结果也不一样的。

6. 代码记得备份，我一时着急，把自己的代码 **cd openpose && rm -r build**， 直接删除了自己在build下写的Python代码，以后记得上传github备份。




<!-- params = dict()
params["model_folder"] = "/home/XXXXX/openpose/models/"
params["net_resolution"] = "160x80" -->